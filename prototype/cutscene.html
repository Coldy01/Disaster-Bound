<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game Intro</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Verdana, sans-serif;
      overflow: hidden;
      background: linear-gradient(rgba(112, 111, 111, 0.5), rgba(112, 111, 111, 0.5));
      background-size: cover;
      color: #fff;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0;
      background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5));
      width: 100%;
      height: 100%;
      background-size: cover;
      filter: brightness(0.9) contrast(1.1) saturate(1.2);
      z-index: -1;
    }

    #typing-text {
      font-family: 'Press Start 2P';
      font-size: 16px;
      max-width: 800px;
      text-align: center;
      margin-bottom: 40px;
      display: none;
      min-height: 200px;
      color: #fff;
      text-shadow: 2px 2px 0 #000;
      margin-top: 20%;
      margin-left:  24%;
    }

    .name-input {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 10%;
    }

    .name-input p {
      font-family: 'Press Start 2P';
      font-size: 14px;
      color: #00b7ff;
      margin: 0;
    }

    .name-input input {
      padding: 10px;
      font-size: 14px;
      text-align: center;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid #00b7ff;
      border-radius: 4px;
      color: #fff;
      font-family: 'Press Start 2P';
    }

    .difficulty {
      display: none;
      gap: 10px;
      margin-top: 20px;
      margin-left: 24%;
    }

    button {
      padding: 15px 30px;
      font-family: 'Press Start 2P';
      font-size: 12px;
      cursor: pointer;
      color: #fff;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid #00b7ff;
      border-radius: 4px;
      text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    button:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #0022ff;
      box-shadow: 0 0 20px #00b7ff;
    }

    .difficulty button {
      width: 180px;
    }

    /* Overlay */
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 20px;
      font-family: 'Press Start 2P';
      z-index: 1000;
      cursor: pointer;
      text-shadow: 2px 2px 0 #000;
    }

    #overlay.fade-out {
      animation: fadeOut 1s forwards;
    }

    @keyframes fadeOut {
      to { opacity: 0; visibility: hidden; }
    }

    /* Skip Prompt */
    #skip-prompt {
      position: fixed;
      bottom: 20px;
      right: 20px;
      color: #888;
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 5px;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
      display: none;
      z-index: 1000;
    }

    @media (max-width: 768px) {
      #typing-text {
        font-size: 12px;
        max-width: 90%;
      }

      .name-input input {
        width: 80%;
      }

      button {
        padding: 12px 20px;
        font-size: 10px;
      }

      .difficulty button {
        width: 140px;
      }
    }
  </style>
</head>
<body>

<!-- Fullscreen Button -->
<button id="fullscreenBtn" style="position: fixed; top: 20px; right: 20px; z-index: 1001; padding: 8px 12px; font-family: 'Press Start 2P', cursive; font-size: 8px; background: rgba(0, 0, 0, 0.6); color: #00b7ff; border: 2px solid #00b7ff; border-radius: 4px; cursor: pointer;">Toggle Fullscreen</button>

<!-- Overlay -->
<div id="overlay">Press any key to play</div>

<!-- Skip Prompt -->
<div id="skip-prompt">Press "E" to skip</div>

  <div id="typing-text"></div>

  <div class="name-input" id="nameInput" style="display: none; flex-direction: column; align-items: center; gap: 20px;">
    <p>Enter your name:</p>
    <input type="text" id="playerName" maxlength="20" style="padding: 10px; font-size: 18px; text-align: center;">
    <button onclick="saveNameAndProceed()">Proceed</button>
  </div>

  <div class="difficulty" id="difficulty" style="display: none;">
    <p>Select Difficulty:</p>
      <button onclick="location.href='game.html'">Normal</button>
      <button onclick="location.href='gameHARD.html'">Hard</button>
      <button onclick="location.href='gameIMPOSSIBLE.html'">Impossible</button>
  </div>

  <!-- Background Audio -->
  <audio id="bg-audio" loop>
    <source src="bgcutscene.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <!-- Typing Sound -->
  <audio id="type-sound">
    <source src="typing.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <script>
    const text = `Welcome to Disasterbound!
You are not awake.
You have entered a lucid realm where reality bends and disasters rise.
Your mission: face the calamity.
The dream will show a series of scenarios, each delivered in form of text. Study them. Choose your move WISELY.
Only the correct decisions will weaken the disaster.
Only victory will unlock your path BACK to consciousness.
Fail... and the dream becomes your new reality.
Prepare yourself...`;

    const lines = text.split("\n");
    const typingElement = document.getElementById("typing-text");
    const difficulty = document.getElementById("difficulty");
    const nameInput = document.getElementById("nameInput");
    const playerNameInput = document.getElementById("playerName");
    const bgAudio = document.getElementById("bg-audio");
    const typeSound = document.getElementById("type-sound");
    const overlay = document.getElementById("overlay");
    const skipPrompt = document.getElementById("skip-prompt");

    let currentLine = 0;
    let typing = false;
    let stopTyping = false;
    let typingSpeed = 50;

    function typeLine(line, callback) {
      stopTyping = false;
      typing = true;
      typingSpeed = 50; // Reset speed for new line
      typingElement.innerHTML = "";
      let i = 0;

      function typingStep() {
        if (stopTyping) {
          typing = false;
          return;
        }
        if (i < line.length) {
          typingElement.innerHTML += line.charAt(i);
          i++;

          // play typing sound
          typeSound.currentTime = 0;
          typeSound.play().catch(()=>{});

          setTimeout(typingStep, typingSpeed);
        } else {
          typing = false;
          if (callback) callback();
        }
      }

      typingStep();
    }

    function showNextLine() {
      if (typing) return;

      if (currentLine < lines.length) {
        typeLine(lines[currentLine], () => {
          currentLine++;
        });
      } else {
        document.removeEventListener("click", showNextLine);
        document.removeEventListener("keydown", showNextLine);
        document.removeEventListener("keydown", handleSkip);
        skipPrompt.style.display = "none";
        nameInput.style.display = "flex";
        playerNameInput.focus();
        bgAudio.pause();
        bgAudio.currentTime = 0;
      }
    }

    function startGame() {
      overlay.classList.add("fade-out");
      setTimeout(() => {
        overlay.style.display = "none";
        typingElement.style.display = "block";
        skipPrompt.style.display = "block";
        bgAudio.play().catch(()=>{});
        showNextLine();
        document.addEventListener("click", showNextLine);
        document.addEventListener("keydown", showNextLine);
        document.addEventListener("keydown", handleSkip);
      }, 1000);
    }

    function saveNameAndProceed() {
      const name = playerNameInput.value.trim();
      if (name) {
        localStorage.setItem('playerName', name);
        nameInput.style.display = "none";
        difficulty.style.display = "flex";
      } else {
        alert("Please enter a name to proceed.");
        playerNameInput.focus();
      }
    }

    function handleSkip(e) {
      if (e.key === 'e' || e.key === 'E') {
        if (typing) {
          // Speed up the typing animation
          typingSpeed = 10;
        }
        // If not typing, do nothing (wait for user to click or press key)
      }
    }

    // Allow pressing Enter to proceed
    playerNameInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        saveNameAndProceed();
      }
    });

    // Fullscreen toggle with state persistence
    function toggleFullscreen() {
      const isFullscreen = !!document.fullscreenElement;

      if (!isFullscreen) {
        document.documentElement.requestFullscreen().catch(err => {
          alert(`Error enabling fullscreen: ${err.message}`);
        });
        localStorage.setItem('fullscreenMode', 'true');
      } else {
        document.exitFullscreen();
        localStorage.setItem('fullscreenMode', 'false');
      }
    }

    // Initialize fullscreen state on page load
    function initializeFullscreenState() {
      const savedFullscreenState = localStorage.getItem('fullscreenMode');

      // Listen for fullscreen changes to update localStorage
      document.addEventListener('fullscreenchange', () => {
        const isCurrentlyFullscreen = !!document.fullscreenElement;
        localStorage.setItem('fullscreenMode', isCurrentlyFullscreen.toString());
      });

      // If user was in fullscreen before and page supports it, try to restore
      if (savedFullscreenState === 'true' && !document.fullscreenElement) {
        // Only attempt to restore if not already in fullscreen
        setTimeout(() => {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(() => {
              // Silently fail if fullscreen is not available
            });
          }
        }, 100);
      }
    }

    // Add fullscreen button event listener
    document.addEventListener('DOMContentLoaded', () => {
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', toggleFullscreen);
      }

      // Initialize fullscreen state
      initializeFullscreenState();
    });

    document.addEventListener("keydown", startGame, { once: true });
    document.addEventListener("click", startGame, { once: true });
  </script>

  <!-- Cutscene page-wide click sound script -->
  <script>
    (function() {
      // Create audio object for cutscene sound effect
      const clickSound = new Audio('audios/cutsceneSoundEffect.mp3');

      // Function to play click sound with overlap prevention
      function playClickSound() {
        // Only play if not already playing (prevents overlap)
        if (clickSound.paused) {
          clickSound.currentTime = 0; // Reset to start
          clickSound.play().catch(() => {}); // Silently handle errors
        }
      }

      // Attach click event to document (page-wide)
      document.addEventListener('click', playClickSound);
    })();
  </script>

  <!-- Shared button sound script -->
  <script src="audio.js"></script>
  </script>

  <!-- Shared button sound script -->
  <script src="audio.js"></script>

</body>
</html>
