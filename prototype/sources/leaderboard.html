<!-- leaderboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leaderboard</title>
  <link rel="stylesheet" href="leaderboard.css" />
</head>
<body>
   <h1 class="page-title">Leaderboard</h1>
   <button id="fullscreenBtn" style="position: fixed; top: 20px; right: 20px; padding: 10px 15px; font-family: 'Press Start 2P', cursive; font-size: 10px; background: rgba(0, 0, 0, 0.6); color: #00b7ff; border: 2px solid #00b7ff; border-radius: 4px; cursor: pointer;">Toggle Fullscreen</button>

   <div class="difficulty-tabs">
     <button class="tab-button active" data-difficulty="normal">Normal</button>
     <button class="tab-button" data-difficulty="hard">Hard</button>
     <button class="tab-button" data-difficulty="impossible">Impossible</button>
   </div>

   <div id="leaderboardContainer">
   <table id="leaderboardTable" border="1" cellpadding="8">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Completion Time</th>
        <th>Mistakes</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
   </div>
  <div style="text-align: center; margin-top: 20px;">
    <button onclick="window.location.href='end.html'">View Last Game</button>
    <button onclick="showConfirmModal()">Back to Main Menu</button>
    </div>

    <!-- CONFIRMATION MODAL -->
    <div id="confirmModal" class="settings-modal hidden">
      <div class="settings-content">
        <p>Do you want to go back to main menu?</p>
        <button id="confirmYes" style="background-color: #ff6b6b; color: white; margin: 10px;">Yes</button>
        <button id="confirmNo" style="background-color: #51cf66; color: white; margin: 10px;">No</button>
      </div>
    </div>
  <script>
    function sortHistory(history, key, ascending = true) {
      return history.sort((a, b) => {
        let aVal, bVal;
        if (key === 'rank') {
          aVal = a.score ?? 99999;
          bVal = b.score ?? 99999;
        } else if (key === 'name') {
          aVal = a[key] ?? 'Anonymous';
          bVal = b[key] ?? 'Anonymous';
        } else {
          aVal = a[key] ?? (key === 'totalTime' ? 9999 : key === 'totalMistakes' ? 999 : '');
          bVal = b[key] ?? (key === 'totalTime' ? 9999 : key === 'totalMistakes' ? 999 : '');
        }
        if (typeof aVal === 'string') {
          return ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        }
        return ascending ? aVal - bVal : bVal - aVal;
      });
    }

    let currentDifficulty = 'normal';
    let history = JSON.parse(localStorage.getItem(`gameHistory_${currentDifficulty}`) || '[]');
    console.log('Loaded game history:', history);
    let currentSortKey = 'rank';
    let sortAscending = true;

    function renderLeaderboard() {
      // Handle old data format
      history.forEach(entry => {
        if (!entry.totalTime && entry.enemy1Time !== undefined) {
          entry.totalTime = (entry.enemy1Time || 0) + (entry.enemy2Time || 0);
          entry.totalMistakes = (entry.enemy1Mistakes || 0) + (entry.enemy2Mistakes || 0);
          entry.score = entry.totalTime + (entry.totalMistakes * 60);
        }
        if (!entry.name) {
          entry.name = 'Anonymous';
        }
      });

      // First, assign ranks based on score
      const rankedHistory = [...history].sort((a, b) => (a.score ?? 99999) - (b.score ?? 99999));
      rankedHistory.forEach((entry, index) => {
        entry.rank = index + 1;
      });

      // Then sort by current criteria
      const sortedHistory = sortHistory(rankedHistory, currentSortKey, sortAscending);
      const tbody = document.querySelector('#leaderboardTable tbody');
      tbody.innerHTML = '';

      if (sortedHistory.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="5" style="text-align: center; padding: 40px;">No games played yet!</td>';
        tbody.appendChild(tr);
        return;
      }

      sortedHistory.forEach((entry) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${entry.rank}</td>
          <td>${entry.name || 'Anonymous'}</td>
          <td>${entry.totalTime || 0}s</td>
          <td>${entry.totalMistakes || 0}</td>
          <td>${entry.date || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Add click handlers for sorting
    document.addEventListener('DOMContentLoaded', () => {
      const headers = document.querySelectorAll('#leaderboardTable th');
      headers.forEach((header, index) => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', () => {
          const sortKeys = ['rank', 'name', 'totalTime', 'totalMistakes', 'date'];
          const key = sortKeys[index];

          if (currentSortKey === key) {
            sortAscending = !sortAscending;
          } else {
            currentSortKey = key;
            sortAscending = (key === 'totalTime' || key === 'totalMistakes') ? true : false;
          }

          // Update header indicators
          headers.forEach(h => h.textContent = h.textContent.replace(' ↑', '').replace(' ↓', ''));
          header.textContent += sortAscending ? ' ↑' : ' ↓';

          renderLeaderboard();
        });
      });

      // Add tab switching logic
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          // Update active tab
          tabButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');

          // Update current difficulty and reload history
          currentDifficulty = button.dataset.difficulty;
          history = JSON.parse(localStorage.getItem(`gameHistory_${currentDifficulty}`) || '[]');
          console.log(`Loaded ${currentDifficulty} game history:`, history);

          // Reset sorting
          currentSortKey = 'rank';
          sortAscending = true;

          // Clear sort indicators
          headers.forEach(h => h.textContent = h.textContent.replace(' ↑', '').replace(' ↓', ''));

          renderLeaderboard();
        });
      });

      renderLeaderboard();
    });

    // Fullscreen toggle with state persistence
    function toggleFullscreen() {
      const isFullscreen = !!document.fullscreenElement;

      if (!isFullscreen) {
        document.documentElement.requestFullscreen().catch(err => {
          alert(`Error enabling fullscreen: ${err.message}`);
        });
        localStorage.setItem('fullscreenMode', 'true');
      } else {
        document.exitFullscreen();
        localStorage.setItem('fullscreenMode', 'false');
      }
    }

    // Initialize fullscreen state on page load
    function initializeFullscreenState() {
      const savedFullscreenState = localStorage.getItem('fullscreenMode');

      // Listen for fullscreen changes to update localStorage
      document.addEventListener('fullscreenchange', () => {
        const isCurrentlyFullscreen = !!document.fullscreenElement;
        localStorage.setItem('fullscreenMode', isCurrentlyFullscreen.toString());
      });

      // If user was in fullscreen before and page supports it, try to restore
      if (savedFullscreenState === 'true' && !document.fullscreenElement) {
        // Only attempt to restore if not already in fullscreen
        setTimeout(() => {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(() => {
              // Silently fail if fullscreen is not available
            });
          }
        }, 100);
      }
    }

    // Confirmation modal functions
    function showConfirmModal() {
      document.getElementById('confirmModal').classList.remove('hidden');
    }

    function hideConfirmModal() {
      document.getElementById('confirmModal').classList.add('hidden');
    }

    // Add fullscreen button event listener
    document.addEventListener('DOMContentLoaded', () => {
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', toggleFullscreen);
      }

      // Initialize fullscreen state
      initializeFullscreenState();

      // Confirmation modal event listeners
      document.getElementById('confirmYes').addEventListener('click', function() {
        window.location.href = 'index.html';
      });

      document.getElementById('confirmNo').addEventListener('click', function() {
        hideConfirmModal();
      });
    });
  </script>

  <!-- Shared button sound script -->
  <script src="audio.js"></script>
</body>
</html>