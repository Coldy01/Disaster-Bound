<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Game Summary</title>
  <link rel="stylesheet" href="end.css" />
</head>
<body>
  <div class="summary-container">
    <button id="fullscreenBtn" style="position: absolute; top: 20px; right: 20px; padding: 8px 12px; font-family: 'Press Start 2P', cursive; font-size: 8px; background: rgba(0, 0, 0, 0.6); color: #00b7ff; border: 2px solid #00b7ff; border-radius: 4px; cursor: pointer;">Toggle Fullscreen</button>
    <h2>Game Summary</h2>
    <div id="summaryDetails"></div>
    <h3 id="leaderboardTitle">Top Performers</h3>
    <table id="endLeaderboardTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Name</th>
          <th>Time</th>
          <th>Mistakes</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="window.location.href='index.html'">Back to Main Menu</button>
    <button onclick="window.location.href='leaderboard.html'">Full Leaderboard</button>
  </div>
  <script>
    const summary = JSON.parse(localStorage.getItem('latestSummary') || '{}');
    let playerRank = '-';

    // Calculate rank for current player
    if (summary.score !== undefined && summary.won) {
      const difficulty = summary.difficulty || 'normal';
      const historyKey = `gameHistory_${difficulty}`;
      const difficultyHistory = JSON.parse(localStorage.getItem(historyKey) || '[]');
      const sortedByScore = difficultyHistory.sort((a, b) => (a.score ?? 99999) - (b.score ?? 99999));
      const playerIndex = sortedByScore.findIndex(entry =>
        entry.date === summary.date && entry.totalTime === summary.totalTime
      );
      if (playerIndex !== -1) {
        playerRank = playerIndex + 1;
      }
    }

    document.getElementById('summaryDetails').innerHTML = `
      <p>üë§ Name: <strong>${summary.name ?? 'Anonymous'}</strong></p>
      <p>‚è± Total Time: <strong>${summary.totalTime ?? '-'}s</strong></p>
      <p>‚ùå Total Mistakes: <strong>${summary.totalMistakes ?? '-'}</strong></p>
      <p>üèÜ Outcome: <strong>${summary.won ? 'Victory' : 'Defeat'}</strong></p>
      <p>üèÖ Rank: <strong>${playerRank}</strong></p>
      <p><em>${summary.date ?? ''}</em></p>
    `;

    // Leaderboard functionality
    function sortHistory(history, key, ascending = true) {
      return history.sort((a, b) => {
        let aVal, bVal;
        if (key === 'rank') {
          aVal = a.score ?? 99999;
          bVal = b.score ?? 99999;
        } else if (key === 'name') {
          aVal = a[key] ?? 'Anonymous';
          bVal = b[key] ?? 'Anonymous';
        } else {
          aVal = a[key] ?? (key === 'totalTime' ? 9999 : key === 'totalMistakes' ? 999 : '');
          bVal = b[key] ?? (key === 'totalTime' ? 9999 : key === 'totalMistakes' ? 999 : '');
        }
        if (typeof aVal === 'string') {
          return ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        }
        return ascending ? aVal - bVal : bVal - aVal;
      });
    }

    const difficulty = summary.difficulty || 'normal';
    const historyKey = `gameHistory_${difficulty}`;
    let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
    let currentSortKey = 'rank';
    let sortAscending = true;

    // Update leaderboard title
    document.getElementById('leaderboardTitle').textContent = `Top Performers - ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`;

    function renderLeaderboard() {
      // Handle old data format
      history.forEach(entry => {
        if (!entry.totalTime && entry.enemy1Time !== undefined) {
          entry.totalTime = (entry.enemy1Time || 0) + (entry.enemy2Time || 0);
          entry.totalMistakes = (entry.enemy1Mistakes || 0) + (entry.enemy2Mistakes || 0);
          entry.score = entry.totalTime + (entry.totalMistakes * 60);
        }
        if (!entry.name) {
          entry.name = 'Anonymous';
        }
      });

      // Assign ranks based on score, handling ties
      const rankedHistory = [...history].sort((a, b) => (a.score ?? 99999) - (b.score ?? 99999));
      let currentRank = 1;
      let previousScore = null;
      rankedHistory.forEach((entry, index) => {
        if (entry.score !== previousScore) {
          currentRank = index + 1;
          previousScore = entry.score;
        }
        entry.rank = currentRank;
      });

      // Sort by current criteria and take top 10
      const sortedHistory = sortHistory(rankedHistory, currentSortKey, sortAscending).slice(0, 10);
      const tbody = document.querySelector('#endLeaderboardTable tbody');
      tbody.innerHTML = '';

      if (sortedHistory.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="5" style="text-align: center; padding: 20px;">No games played yet!</td>';
        tbody.appendChild(tr);
        return;
      }

      sortedHistory.forEach((entry) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${entry.rank}</td>
          <td>${entry.name}</td>
          <td>${entry.totalTime || 0}s</td>
          <td>${entry.totalMistakes || 0}</td>
          <td>${entry.date || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Add click handlers for sorting
    document.addEventListener('DOMContentLoaded', () => {
      const headers = document.querySelectorAll('#endLeaderboardTable th');
      headers.forEach((header, index) => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', () => {
          const sortKeys = ['rank', 'name', 'totalTime', 'totalMistakes', 'date'];
          const key = sortKeys[index];

          if (currentSortKey === key) {
            sortAscending = !sortAscending;
          } else {
            currentSortKey = key;
            sortAscending = (key === 'totalTime' || key === 'totalMistakes') ? true : false;
          }

          // Update header indicators
          headers.forEach(h => h.textContent = h.textContent.replace(' ‚Üë', '').replace(' ‚Üì', ''));
          header.textContent += sortAscending ? ' ‚Üë' : ' ‚Üì';

          renderLeaderboard();
        });
      });

      renderLeaderboard();
    });

    // Fullscreen toggle with state persistence
    function toggleFullscreen() {
      const isFullscreen = !!document.fullscreenElement;

      if (!isFullscreen) {
        document.documentElement.requestFullscreen().catch(err => {
          alert(`Error enabling fullscreen: ${err.message}`);
        });
        localStorage.setItem('fullscreenMode', 'true');
      } else {
        document.exitFullscreen();
        localStorage.setItem('fullscreenMode', 'false');
      }
    }

    // Initialize fullscreen state on page load
    function initializeFullscreenState() {
      const savedFullscreenState = localStorage.getItem('fullscreenMode');

      // Listen for fullscreen changes to update localStorage
      document.addEventListener('fullscreenchange', () => {
        const isCurrentlyFullscreen = !!document.fullscreenElement;
        localStorage.setItem('fullscreenMode', isCurrentlyFullscreen.toString());
      });

      // If user was in fullscreen before and page supports it, try to restore
      if (savedFullscreenState === 'true' && !document.fullscreenElement) {
        // Only attempt to restore if not already in fullscreen
        setTimeout(() => {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(() => {
              // Silently fail if fullscreen is not available
            });
          }
        }, 100);
      }
    }

    // Add fullscreen button event listener
    document.addEventListener('DOMContentLoaded', () => {
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', toggleFullscreen);
      }

      // Initialize fullscreen state
      initializeFullscreenState();
    });
  </script>
  <!-- Shared button sound script -->
  <script src="audio.js"></script>
</body>
</html>